<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GAP - Redefinir Senha</title>
    <link rel="stylesheet" href="styles/style.css" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#A0430A",
                        secondary: "#DFE8E6",
                        "background-light": "#f8f7f6", 
                        "background-dark": "#121212", 
                        "surface-light": "#ffffff",    
                        "surface-dark": "#1E1E1E",     
                        "text-light": "#1a1a1a",
                        "text-dark": "#e5e5e5",
                        "text-muted-light": "#666666",
                        "text-muted-dark": "#a3a3a3",
                        border: "rgba(0,0,0,0.08)",
                        "border-dark": "rgba(255,255,255,0.08)",
                    },
                    fontFamily: {
                        display: ["Manrope", "sans-serif"]
                    },
                    borderRadius: {
                        DEFAULT: "0.5rem",
                        xl: "0.75rem",
                        "2xl": "1rem",
                        "3xl": "1.5rem"
                    }
                },
            },
        };
    </script>
    <link
      href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /* Oculta o body até validar o token */
      body {
        display: none;
      }
    </style>
  </head>

  <body>
    <div class="main-container">
      <div class="view-container login-view">
        <div class="left-banner light-bg">
          <div class="banner-content">
            <img src="img/burnt-cooper.svg" class="logo-big" alt="Logo GAP" />
            <h1 class="banner-title">Crie uma nova senha</h1>
            <p class="banner-desc">
              Digite sua nova senha para recuperar o acesso à sua conta.
            </p>
            <img
              src="img/login.svg"
              class="illustration"
              alt="Redefinir senha"
            />
          </div>
        </div>

        <div class="right-form white-bg">
          <div class="form-wrapper">
            <h2 class="form-title">Redefinir Senha</h2>
            <p class="form-subtitle">Digite sua nova senha forte e segura.</p>

            <form id="resetPasswordForm" class="form-box">
              <div class="input-group">
                <label for="new-password">Nova Senha</label>
                <div class="input-wrapper">
                  <svg class="icon" viewBox="0 0 24 24">
                    <rect x="3" y="11" width="18" height="11" rx="2"></rect>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                  </svg>
                  <input
                    type="password"
                    placeholder="Digite sua nova senha"
                    id="new-password"
                    required
                  />
                  <button
                    type="button"
                    class="toggle-password"
                    data-target="new-password"
                  >
                    <svg viewBox="0 0 24 24" class="eye-icon">
                      <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" />
                      <circle cx="12" cy="12" r="3" />
                    </svg>
                  </button>
                </div>
                <small class="password-hint">
                  Mínimo 8 caracteres, incluindo: letra maiúscula e caractere especial (!@#$%...)
                </small>
              </div>

              <div class="input-group">
                <label for="confirm-password">Confirmar Nova Senha</label>
                <div class="input-wrapper">
                  <svg class="icon" viewBox="0 0 24 24">
                    <rect x="3" y="11" width="18" height="11" rx="2"></rect>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                  </svg>
                  <input
                    type="password"
                    placeholder="Confirme sua nova senha"
                    id="confirm-password"
                    required
                  />
                  <button
                    type="button"
                    class="toggle-password"
                    data-target="confirm-password"
                  >
                    <svg viewBox="0 0 24 24" class="eye-icon">
                      <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" />
                      <circle cx="12" cy="12" r="3" />
                    </svg>
                  </button>
                </div>
              </div>

              <button class="w-full px-8 py-3 rounded-xl bg-primary text-white font-bold shadow-lg shadow-primary/25 hover:bg-primary/90 hover:shadow-primary/40 active:scale-95 transition-all duration-200" type="submit">Redefinir Senha</button>
            </form>

            <p class="switch-text">
              Lembrou sua senha?
              <a href="/" id="linkBackToLogin" class="hover:underline">Fazer login</a>
            </p>
          </div>
        </div>
      </div>
    </div>

    <script>
      // =========================================
      // VALIDAÇÃO DE SEGURANÇA - TOKEN OBRIGATÓRIO
      // =========================================
      (function validateResetToken() {
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        // Se não tem token, redireciona para login
        if (!token) {
          alert('⚠️ Link de redefinição inválido. Solicite um novo link.');
          window.location.replace('/login');
          return;
        }

        // Mostra a página após validar que há token
        document.body.style.display = 'block';
      })();

      // Previne navegação para trás
      history.pushState(null, '', location.href);
      window.addEventListener('popstate', function() {
        history.pushState(null, '', location.href);
      });

      // Toggle visibilidade de senha
      document.querySelectorAll('.toggle-password').forEach((button) => {
        button.addEventListener('click', () => {
          const targetId = button.dataset.target;
          const input = document.getElementById(targetId);
          input.type = input.type === 'password' ? 'text' : 'password';
        });
      });

      // Handler do formulário
      document.getElementById('resetPasswordForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const btn = e.target.querySelector('button[type="submit"]');
        const txtOriginal = btn.innerText;

        // Pegar token da URL
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        if (!token) {
          alert('❌ Token inválido. Use o link enviado no seu email.');
          return;
        }

        const newPassword = document.getElementById('new-password').value;
        const confirmPassword = document.getElementById('confirm-password').value;

        // Validar se senhas coincidem
        if (newPassword !== confirmPassword) {
          alert('❌ As senhas não coincidem.');
          return;
        }

        // Validar força da senha
        if (newPassword.length < 8) {
          alert('❌ A senha deve ter no mínimo 8 caracteres.');
          return;
        }

        if (!/[A-Z]/.test(newPassword)) {
          alert('❌ A senha deve conter pelo menos uma letra maiúscula.');
          return;
        }

        if (!/[!@#$%^&*(),.?":{}|<>]/.test(newPassword)) {
          alert('❌ A senha deve conter pelo menos um caractere especial.');
          return;
        }

        btn.innerText = 'Redefinindo...';
        btn.disabled = true;

        try {
          const response = await fetch('/api/v1/users/reset-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token, newPassword }),
          });

          const result = await response.json();

          if (response.ok) {
            alert(`✅ ${result.message || 'Senha redefinida com sucesso!'}`);
            window.location.replace('/login');
          } else {
            alert(`❌ ${result.error || 'Falha ao redefinir senha.'}`);
          }
        } catch (error) {
          console.error('❌ Erro de conexão:', error);
          alert('❌ Erro de conexão com o servidor.');
        } finally {
          btn.innerText = txtOriginal;
          btn.disabled = false;
        }
      });
    </script>
  </body>
</html>
